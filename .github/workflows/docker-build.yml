name: Docker Build
on:
  workflow_dispatch:
    inputs:
      publish:
        description: 'Push images to Docker Hub'
        required: true
        type: boolean
        default: false
  pull_request:
  release:
    types: [published]

permissions: {}

jobs:
  get-versions:
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.get-versions.outputs.versions }}
    steps:
      - name: Get review versions from docker-review repo
        id: get-versions
        run: |
          # Get directory list from vvakame/docker-review repository
          REVIEW_VERSIONS=$(curl -s https://api.github.com/repos/vvakame/docker-review/contents | \
            jq -r '[.[] | select(.type == "dir" and (.name | test("^review-[0-9]+\\.[0-9]+$"))) | .name | ltrimstr("review-")] | sort_by(split(".") | map(tonumber)) | reverse')
          # Add "latest" to the beginning and output as compact JSON
          VERSIONS=$(echo "${REVIEW_VERSIONS}" | jq -c '. = ["latest"] + .')
          echo "versions=${VERSIONS}" >> $GITHUB_OUTPUT
          echo "Found versions: ${VERSIONS}"

  push_to_registries:
    needs: get-versions
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJson(needs.get-versions.outputs.versions) }}
    steps:
      - name: Check out the repo
        uses: actions/checkout@v6
        with:
          persist-credentials: false
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0
      - name: Log in to Docker Hub
        if: github.event_name == 'release' || inputs.publish
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and Push to Docker Hub
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          push: ${{ (github.event_name == 'release' || inputs.publish) && matrix.version == 'latest' }}
          load: true
          file: ${{ github.event_name == 'pull_request' && 'Dockerfile.local' || 'Dockerfile' }}
          build-args: |
            REVIEW_VERSION=${{ matrix.version }}
          tags: srzzumix/review-retrovert:${{ matrix.version }}
      - name: Push review-retrovert version tag
        if: github.event_name == 'release' || inputs.publish
        env:
          DOCKER_TAG: ${{ matrix.version }}
          IMAGE_NAME: srzzumix/review-retrovert:${{ matrix.version }}
          DOCKER_REPO: srzzumix/review-retrovert
        run: |
          ./hooks/post_push
