#!/bin/bash
set -eu

# Get review-retrovert version and Re:VIEW version
VERSION=$(docker run --rm ${IMAGE_NAME} version)
REVIEW_VERSION=$(docker run --rm ${IMAGE_NAME} review-version)

if [ "${DOCKER_TAG}" = "latest" ]; then
  # For latest tag, push retrovert version tag
  docker tag ${IMAGE_NAME} ${DOCKER_REPO}:${VERSION}
  docker push ${DOCKER_REPO}:${VERSION}
  # Also push combined tag with Re:VIEW version (e.g., 0.10.0-review5.10)
  COMBINED_TAG="${VERSION}-review${REVIEW_VERSION}"
  docker tag ${IMAGE_NAME} ${DOCKER_REPO}:${COMBINED_TAG}
  docker push ${DOCKER_REPO}:${COMBINED_TAG}
else
  # For review version tags (e.g., 5.9), push combined tag (e.g., 0.10.0-review5.9)
  COMBINED_TAG="${VERSION}-review${DOCKER_TAG}"
  docker tag ${IMAGE_NAME} ${DOCKER_REPO}:${COMBINED_TAG}
  docker push ${DOCKER_REPO}:${COMBINED_TAG}
fi
